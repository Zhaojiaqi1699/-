// ==UserScript==
// @name         ç½‘é¡µæ–‡æœ¬ä¿å­˜å·¥å…·ï¼ˆåŠ¨æ€ä½ç½®ç‰ˆï¼‰
// @namespace    https://github.com/Zhaojiaqi1699
// @version      1.1
// @description  é€‰ä¸­ç½‘é¡µæ–‡å­—åï¼Œç‚¹å‡»æ‚¬æµ®æŒ‰é’®ä¿å­˜åˆ°æœ¬åœ°TXTæ–‡ä»¶ï¼ˆå¯å¤šæ¬¡ä¿å­˜ï¼‰
// @author       èµµå®¶ç¦
// @match        *://*/*
// @grant        GM_download
// @grant        GM_addStyle
// ==/UserScript==

(function() {
    'use strict';

    // è‡ªå®šä¹‰æŒ‰é’®æ ·å¼
    GM_addStyle(`
        .save-text-btn {
            position: absolute; /* ä¿®æ”¹ä¸ºç»å¯¹å®šä½ */
            z-index: 999999;
            padding: 12px 20px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            box-shadow: 0 3px 6px rgba(0,0,0,0.16);
            font-family: Arial;
            font-size: 14px;
            transition: 0.3s;
            opacity: 0;
            transform: translateY(100%);
        }
        .save-text-btn.show {
            opacity: 1;
            transform: translateY(0);
        }
        .save-text-btn:hover {
            background: #1976D2;
            box-shadow: 0 5px 10px rgba(0,0,0,0.2);
        }
    `);

    // åˆ›å»ºæŒ‰é’®
    const saveBtn = document.createElement('button');
    saveBtn.className = 'save-text-btn';
    saveBtn.textContent = 'ğŸ’¾ ä¿å­˜é€‰ä¸­å†…å®¹';
    document.body.appendChild(saveBtn);

    // æ–‡æœ¬ç¼“å­˜ï¼ˆç”¨äºå¤šæ¬¡ä¿å­˜ï¼‰
    let savedTexts = [];

    // æ˜¾ç¤º/éšè—æŒ‰é’®
    function toggleButton(show, x, y) {
        if (show) {
            saveBtn.style.left = `${x}px`;
            saveBtn.style.top = `${y}px`;
        }
        saveBtn.classList[show ? 'add' : 'remove']('show');
    }

    // æ£€æµ‹æ–‡æœ¬é€‰æ‹©
    document.addEventListener('mouseup', function(e) {
        const selection = window.getSelection().toString().trim();
        if (selection.length > 0) {
            const range = window.getSelection().getRangeAt(0);
            const rect = range.getBoundingClientRect();
            const x = rect.left + window.pageXOffset;
            const y = rect.top + window.pageYOffset - saveBtn.offsetHeight;
            toggleButton(true, x, y);
        } else {
            toggleButton(false);
        }
    });

    // ä¿å­˜åŠŸèƒ½
    saveBtn.addEventListener('click', () => {
        const selection = window.getSelection().toString().trim();
        if (!selection) return;

        // æ·»åŠ åˆ°ç¼“å­˜
        savedTexts.push({
            text: selection,
            time: new Date().toLocaleString()
        });

        // ç”Ÿæˆæ–‡ä»¶å†…å®¹
        const fileContent = savedTexts
            .map((entry, index) => `ã€è®°å½•${index + 1}ã€‘${entry.time}\n${entry.text}\n`)
            .join('\n');

        // åˆ›å»ºæ–‡ä»¶å
        const fileName = `ç½‘é¡µæ–‡æœ¬æ”¶é›†_${new Date()
            .toISOString()
            .slice(0, 10)
            .replace(/-/g, '')}.txt`;

        // ä¿å­˜æ–‡ä»¶
        GM_download({
            url: URL.createObjectURL(new Blob([fileContent], { type: 'text/plain' })),
            name: fileName,
            saveAs: true,
            onload: () => toggleButton(false)
        });
    });

    // åŒå‡»æŒ‰é’®æ¸…ç©ºç¼“å­˜
    saveBtn.addEventListener('dblclick', () => {
        savedTexts = [];
        alert('å·²æ¸…ç©ºæ–‡æœ¬ç¼“å­˜ï¼');
        toggleButton(false);
    });
})();
